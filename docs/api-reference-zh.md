# BottleCRM API 功能概览

## 简介

BottleCRM 提供了完整的 RESTful API,让您可以通过编程方式管理整个 CRM 系统。无论是构建移动应用、集成第三方服务,还是实现自动化工作流,API 都能满足您的需求。

**基础 URL**: `http://localhost:3001/api` (默认端口: 3001)  
**API 文档**: `http://localhost:3001/api-docs` (Swagger 交互式文档)

## 核心特性

### 🔐 灵活的身份认证
- **多种登录方式**: 支持邮箱密码登录和 Google OAuth 登录
- **安全可靠**: 使用 JWT 令牌进行身份验证,支持令牌撤销和过期管理
- **密码安全**: Bcrypt 加密存储,强密码策略验证(最少8位,包含大小写字母和数字)

### 🏢 多租户架构
- **组织隔离**: 完全的数据隔离,确保不同组织之间数据安全
- **灵活的组织管理**: 用户可以加入多个组织,在不同组织中拥有不同角色
- **访问控制**: 自动验证用户的组织成员资格,防止越权访问

### 🛡️ 企业级安全
- **速率限制**: 防止 API 滥用 (每 IP 每 15 分钟 100 次请求)
- **安全头部**: 集成 Helmet 中间件
- **CORS 支持**: 可配置的跨域访问控制
- **请求日志**: 可配置的请求/响应日志记录

### 📊 完整的 CRM 功能
涵盖从线索获取到客户管理的完整销售周期

---

## 功能模块

### 1️⃣ 用户认证与授权

#### 用户注册与登录
- **邮箱密码注册**: 创建新用户账户,自动创建默认组织
- **邮箱密码登录**: 使用凭证登录,获取 JWT 令牌
- **Google OAuth**: 支持移动应用的 Google 登录集成
- **获取用户信息**: 查询当前登录用户的详细信息和组织列表

#### 会话管理
- **安全登出**: 撤销当前使用的 JWT 令牌
- **批量撤销**: 一键撤销用户的所有活跃令牌(用于安全事件响应)
- **令牌过期**: 自动令牌过期机制(默认 24 小时)

**适用场景**:
- 移动应用开发
- 单点登录(SSO)集成
- 第三方应用授权
- 安全审计和会话管理

---

### 2️⃣ 组织管理

#### 组织操作
- **查看组织列表**: 获取当前用户所属的所有组织
- **创建新组织**: 创建新的租户空间,创建者自动成为管理员
- **组织搜索**: 按名称、行业等条件搜索组织
- **组织过滤**: 按激活状态、行业类型等筛选

#### 组织信息
- **基本信息**: 组织名称、域名、Logo、网站
- **业务信息**: 行业分类、描述信息
- **成员角色**: 查看用户在组织中的角色(管理员/普通用户)
- **加入时间**: 追踪用户加入组织的时间

**适用场景**:
- SaaS 多租户应用
- 企业级 CRM 部署
- 代理商/分销商管理
- 团队协作平台

---

### 3️⃣ 线索管理

#### 线索全生命周期
- **线索列表**: 查看组织的所有销售线索
- **线索详情**: 获取单个线索的完整信息
- **创建线索**: 录入新的潜在客户信息
- **线索元数据**: 获取线索状态、来源、行业等枚举值

#### 高级功能
- **分页查询**: 支持大量线索的分页浏览
- **多维搜索**: 按姓名、邮箱、公司名称搜索
- **智能过滤**: 
  - 按状态过滤(新建、待联系、已联系、已确认、未确认、已转化)
  - 按来源过滤(网站、电话、合作伙伴、冷呼、展会等)
  - 按行业过滤
  - 按评级过滤(热线索、温线索、冷线索)
  - 按转化状态过滤

#### 线索状态管理
- **NEW**: 新线索,刚进入系统
- **PENDING**: 待联系,已分配但未联系
- **CONTACTED**: 已联系,已建立初步沟通
- **QUALIFIED**: 已确认,符合目标客户画像
- **UNQUALIFIED**: 未确认,不符合目标客户
- **CONVERTED**: 已转化,转化为客户/销售机会

**适用场景**:
- 营销自动化集成
- 网站表单提交处理
- 销售线索分配系统
- 线索评分和培育
- CRM 数据迁移

---

### 4️⃣ 客户账户管理

#### 账户操作
- **账户列表**: 查看组织的所有客户账户
- **创建账户**: 添加新的企业客户
- **账户信息**: 公司名称、行业、联系方式、网站等

#### 账户关系
- **负责人信息**: 追踪账户的负责销售人员
- **关联联系人**: 查看账户下的所有联系人
- **关联销售机会**: 查看账户的销售机会
- **活动历史**: 追踪与账户相关的所有活动

**适用场景**:
- B2B 客户管理
- 企业客户数据库
- 客户分级管理
- 销售区域划分

---

### 5️⃣ 联系人管理

#### 联系人操作
- **联系人列表**: 查看组织的所有联系人
- **联系人详情**: 获取单个联系人的完整信息
- **创建联系人**: 添加新的个人联系人
- **关联账户**: 将联系人关联到企业账户

#### 联系人信息
- **基本信息**: 姓名、邮箱、电话
- **职位信息**: 职位、部门
- **地址信息**: 完整的邮寄地址(街道、城市、州、邮编、国家)
- **备注描述**: 自定义描述信息
- **负责人**: 联系人的负责销售人员

**适用场景**:
- 客户关系维护
- 邮件营销列表
- 销售跟进管理
- 客户通讯录同步

---

### 6️⃣ 销售机会管理

#### 机会操作
- **机会列表**: 查看组织的所有销售机会
- **创建机会**: 创建新的销售机会
- **机会追踪**: 追踪销售机会的进展

#### 机会信息
- **基本信息**: 机会名称、预期金额、预计成交日期
- **销售阶段**: 追踪机会在销售漏斗中的位置
- **关联账户**: 链接到相关的客户账户
- **负责人**: 指定机会的负责销售人员

**适用场景**:
- 销售漏斗管理
- 销售预测分析
- 业绩目标追踪
- 销售流程自动化

---

### 7️⃣ 任务管理

#### 任务操作
- **任务列表**: 查看所有任务,支持多维度过滤
- **任务详情**: 获取任务的完整信息和评论历史
- **创建任务**: 创建新的待办任务
- **更新任务**: 修改任务状态、优先级等信息
- **删除任务**: 删除不需要的任务
- **任务评论**: 为任务添加评论和讨论

#### 任务过滤
- **按状态过滤**: 未开始、进行中、已完成、已延期、等待中
- **按优先级过滤**: 高、普通、低
- **按负责人过滤**: 查看特定用户的任务
- **按关联实体过滤**: 
  - 客户账户相关任务
  - 联系人相关任务
  - 线索相关任务
  - 销售机会相关任务
  - 工单相关任务

#### 任务关联
- **多实体关联**: 任务可以关联到账户、联系人、线索、机会、工单
- **负责人指定**: 分配任务给团队成员
- **截止日期**: 设置任务的到期时间
- **任务描述**: 详细的任务说明

**适用场景**:
- 销售跟进提醒
- 客户服务任务
- 团队协作管理
- 工作流自动化
- 项目管理集成

---

### 8️⃣ 仪表板与数据分析

#### 仪表板概览
- **关键指标**: 一次性获取所有核心 CRM 指标
- **实时数据**: 实时统计组织的业务数据

#### 核心指标
- **线索统计**: 总线索数量
- **销售机会**: 总机会数量和预期收入
- **客户账户**: 总账户数量
- **联系人**: 总联系人数量
- **待办任务**: 待处理任务数量
- **收入预测**: 销售机会的总金额

#### 最近活动
- **最新线索**: 最近创建的线索
- **最新机会**: 最近的销售机会
- **待办任务**: 即将到期的任务
- **活动记录**: 最近的系统活动

#### 轻量级端点
- **仅指标查询**: 快速获取核心指标,不包含详细数据
- **性能优化**: 适用于频繁刷新的仪表板

**适用场景**:
- 管理驾驶舱
- 销售业绩看板
- 移动端快速查看
- 数据可视化集成
- BI 工具对接

---

## 数据安全与访问控制

### 多租户隔离
- **组织级隔离**: 所有数据查询自动按组织过滤
- **成员验证**: 自动验证用户是否属于指定组织
- **跨组织隔离**: 无法访问其他组织的数据

### 身份认证要求
- **JWT 令牌**: 所有受保护端点需要有效的 JWT 令牌
- **组织上下文**: 需要在请求头中指定组织 ID
- **令牌撤销**: 支持主动撤销已颁发的令牌

### 角色权限
- **管理员**: 拥有组织的完全访问权限
- **普通用户**: 标准访问权限
- **超级管理员**: @micropyramid.com 域名用户拥有平台级权限

---

## 技术特性

### RESTful 设计
- **标准 HTTP 方法**: GET、POST、PUT、DELETE
- **资源导向**: 清晰的资源路径结构
- **状态码**: 标准 HTTP 状态码(200、201、400、401、404、409、500)

### 数据格式
- **JSON**: 所有请求和响应使用 JSON 格式
- **日期时间**: ISO 8601 格式
- **分页**: 支持 offset/limit 和 page/limit 两种分页方式

### 性能优化
- **分页查询**: 避免一次性加载大量数据
- **字段选择**: 支持只返回需要的字段
- **关联查询**: 优化的数据库查询,减少 N+1 问题

### 错误处理
- **统一错误格式**: 所有错误响应格式一致
- **详细错误信息**: 提供清晰的错误描述
- **验证错误**: 详细的字段验证错误信息

---

## 集成场景

### 移动应用开发
- 使用 JWT 认证构建 iOS/Android 应用
- Google OAuth 支持原生登录体验
- RESTful API 易于集成到任何移动框架

### 第三方集成
- **营销自动化**: 同步线索到 CRM
- **邮件系统**: 集成邮件营销平台
- **客服系统**: 同步工单和客户信息
- **BI 工具**: 导出数据到分析平台

### 自动化工作流
- **Webhook 触发**: 在特定事件时调用 API
- **定时任务**: 定期同步数据
- **批量操作**: 批量创建/更新记录

### 数据迁移
- 从其他 CRM 系统迁移数据
- 批量导入历史数据
- 数据清洗和转换
